var app = new Framework7({
  // App id
  //id: 'com.myapp.test',
  // Enable swipe panel
  //panel: {
  //  swipe: 'left',
  //},
  // ... other parameters
});
var coords = [
/*  [
   {lat: 53.527218, lng: -113.523288},
   {lat: 53.527212, lng: -113.522352},
   {lat: 53.526306, lng: -113.522341},
   {lat: 53.526324, lng: -113.523212},
   {lat: 53.527218, lng: -113.523288},
  ],
  [
   {lat: 53.527239, lng: -113.522346},
   {lat: 53.527249, lng: -113.520967},
   {lat: 53.526281, lng: -113.520979},
   {lat: 53.526293, lng: -113.522342},
   {lat: 53.527239, lng: -113.522346},
  ],*/
/*

 [
   {lat: 30.018170, lng: 31.226939},
   {lat: 30.018043, lng: 31.227252},
   {lat: 30.017656, lng: 31.227135},
   {lat: 30.017845, lng: 31.226751},
   {lat: 30.018170, lng: 31.226939},
 ],
 [
   {lat: 30.017768, lng: 31.226669},
   {lat: 30.017635, lng: 31.227082},
   {lat: 30.017403, lng: 31.227061},
   {lat: 30.017514, lng: 31.226358},
   {lat: 30.017768, lng: 31.226669},
 ],
 [
   {lat: 53.519072, lng: -113.522007},
   {lat: 53.518962, lng: -113.517668},
   {lat: 53.517355, lng: -113.517522},
   {lat: 53.517063, lng: -113.523125},
   {lat: 53.519072, lng: -113.522007},
 ],*/

 [
  {lat: 53.485628, lng: -113.507457},
  {lat: 53.485649, lng: -113.506239},
  {lat: 53.485218, lng: -113.506281},
  {lat: 53.485258, lng: -113.507282},
  {lat: 53.485628, lng: -113.507457},
 ],
 [
  {lat: 53.485201, lng: -113.507295},
  {lat: 53.485186, lng: -113.506349},
  {lat: 53.484877, lng: -113.506306},
  {lat: 53.484902, lng: -113.507470},
  {lat: 53.485201, lng: -113.507295},
 ],
 [
  {lat: 53.485558, lng: -113.508167},
  {lat: 53.485563, lng: -113.507400},
  {lat: 53.484828, lng: -113.507460},
  {lat: 53.484830, lng: -113.508103},
  {lat: 53.485558, lng: -113.508167},
 ],
  // arts quads
  /*
  [
   {lat: 53.527252, lng: -113.522350},
   {lat: 53.527254, lng: -113.520954},
   {lat: 53.526738, lng: -113.520953},
   {lat: 53.526734, lng: -113.522352},
   {lat: 53.527252, lng: -113.522350},
  ],
  [
   {lat: 53.526679, lng: -113.522352},
   {lat: 53.526683, lng: -113.520945},
   {lat: 53.526292, lng: -113.520962},
   {lat: 53.526319, lng: -113.522353},
   {lat: 53.526679, lng: -113.522352},
  ],
  [
   {lat: 53.526324, lng: -113.522918},
   {lat: 53.526275, lng: -113.522208},
   {lat: 53.525811, lng: -113.522183},
   {lat: 53.525824, lng: -113.522923},
   {lat: 53.526324, lng: -113.522918},
 ],*/

/*
 //London Lewis Cubitt Park
  [
   {lat: 51.538072, lng: -0.125561},
   {lat: 51.537972, lng: -0.124949},
   {lat: 51.537509, lng: -0.125141},
   {lat: 51.537649, lng: -0.125791},
   {lat: 51.538072, lng: -0.125561},
  ],
  [
   {lat: 51.538567, lng: -0.125344},
   {lat: 51.538482, lng: -0.124712},
   {lat: 51.538016, lng: -0.124937},
   {lat: 51.538135, lng: -0.125553},
   {lat: 51.538567, lng: -0.125344},
  ],
  [
   {lat: 51.539017, lng: -0.125161},
   {lat: 51.538892, lng: -0.124535},
   {lat: 51.538486, lng: -0.124718},
   {lat: 51.538583, lng: -0.125341},
   {lat: 51.539017, lng: -0.125161},
  ],
*/
  [
   {lat: 53.490038, lng: -113.544320},
   {lat: 53.489572, lng: -113.544310},
   {lat: 53.489498, lng: -113.547872},
   {lat: 53.490044, lng: -113.548882},
   {lat: 53.490038, lng: -113.544320},
 ],

 [
   {lat: 53.489572, lng: -113.544310},
   {lat: 53.488146, lng: -113.544097},
   {lat: 53.488175, lng: -113.547743},
   {lat: 53.489498, lng: -113.547872},
   {lat: 53.489572, lng: -113.544310},
 ],

 [
   {lat: 53.490038, lng: -113.544320},
   {lat: 53.490041, lng: -113.543142},
   {lat: 53.488228, lng: -113.542997},
   {lat: 53.488146, lng: -113.544097},
   {lat: 53.490038, lng: -113.544320},
 ],
 [
   {lat: 53.519072, lng: -113.522007},
   {lat: 53.518962, lng: -113.517668},
   {lat: 53.517355, lng: -113.517522},
   {lat: 53.517063, lng: -113.523125},
   {lat: 53.519072, lng: -113.522007},
 ],
 [// garden valleys:
   {lat: 53.4076, lng: -113.7602},
   {lat: 53.4077, lng: -113.7597},
   {lat: 53.4067, lng: -113.7582},
   {lat: 53.4061, lng: -113.7585},
   {lat: 53.4076, lng: -113.7602},
  ],
  [
   {lat: 53.4072, lng: -113.7585},
   {lat: 53.4067, lng: -113.7577},
   {lat: 53.4068, lng: -113.7573},
   {lat: 53.4073, lng: -113.7581},
   {lat: 53.4072, lng: -113.7585},
  ],

 [
   {lat: 53.4074, lng: -113.7581},
   {lat: 53.4069, lng: -113.7572},
   {lat: 53.4074, lng: -113.7563},
   {lat: 53.4079, lng: -113.7572},
   {lat: 53.4074, lng: -113.7581},
  ],
  [
   {lat: 53.4075, lng: -113.7565},
   {lat: 53.4072, lng: -113.7560},
   {lat: 53.4081, lng: -113.7543},
   {lat: 53.4084, lng: -113.7552},
   {lat: 53.4075, lng: -113.7565},
  ],

  [
   {lat: 53.4091, lng: -113.7563},
   {lat: 53.4083, lng: -113.7542},
   {lat: 53.4090, lng: -113.7534},
   {lat: 53.4098, lng: -113.7557},
   {lat: 53.4091, lng: -113.7563},
  ],
  [
   {lat: 53.4090, lng: -113.7566},
   {lat: 53.4087, lng: -113.7556},
   {lat: 53.4079, lng: -113.7568},
   {lat: 53.4084, lng: -113.7577},
   {lat: 53.4090, lng: -113.7566},
  ],
   [
   {lat: 53.4082, lng: -113.7580},
   {lat: 53.4079, lng: -113.7574},
   {lat: 53.4074, lng: -113.7589},
   {lat: 53.4079, lng: -113.7592},
   {lat: 53.4082, lng: -113.7580},
  ],
];
var allinfo = [];
var numValleys = 14;
var user_position; // which valley the user is at.
var user_marker;
var marker = user_marker;
var pos, prevpos = -1, prevposs = -1;
var prev = -1;
var switch_history = [];
var maps;
var cur_pos;
var is_init_pos = false;
var switch_history_length = document.getElementById("switch_history_length").value;
var num_marker_pos = [
//  {lat: 30.017865, lng: 31.226962},
//  {lat: 30.017600, lng: 31.226734},
  {lat: 53.526981, lng: -113.521511},
{lat: 53.526512, lng: -113.521937},
{lat: 53.526092, lng: -113.522524},
{lat: 53.527663, lng: -113.514191},
{lat: 53.527663, lng: -113.514191},
{lat: 53.527663, lng: -113.514191},
{lat: 53.527663, lng: -113.514191},
  {lat: 53.407241, lng: -113.7596},
  {lat: 53.407101, lng: -113.7580},
  {lat: 53.407501, lng: -113.7574},
  {lat: 53.407801, lng: -113.7559},
  {lat: 53.408801, lng: -113.7555},
  {lat: 53.408401, lng: -113.7567},
  {lat: 53.407701, lng: -113.7587}
];

// get polygons according to coords.
function drawPolygons() {
  // Construct the polygon.
  var colos = ['#80ccff', '#ffff80', '#ff8080', '#ffffff', '#80ff80', '#000000', '#bfbfbf'];
  var v = [];
  for (var i = 0; i < numValleys; i++) {
    v[i] = new google.maps.Polygon({
      paths: coords[i],
      strokeColor: colos[i%7],
      strokeOpacity: 0.6,
      strokeWeight: 3,
      fillColor: colos[i%7],
      fillOpacity: 0.5
    });
  }
  return v;
}

// check if the point is inside polygon.
// https://stackoverflow.com/questions/22521982/check-if-point-inside-a-polygon
function inside(point, vs) {
  // ray-casting algorithm based on
  // http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html

  var x = point.lat, y = point.lng;

  var inside = false;
  for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
    var xi = vs[i].lat, yi = vs[i].lng;
    var xj = vs[j].lat, yj = vs[j].lng;

    var intersect = ((yi > y) != (yj > y))
        && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
};

function findValley (pos) {
  var val = -1;
  for (var i = 0; i < numValleys; i++) {
    vs = coords[i];
    ret = inside(pos, vs);
    if (ret) {
      val = i;
      break;
    }
  }
  return val;
}

//https://bagja.net/blog/track-user-location-google-maps.html
var createMap = ({ lat, lng }) => {
  return new google.maps.Map(document.getElementById('map'), {
    center: { lat, lng },
    disableDefaultUI: true,
    zoom: 16
  });
};


var createMarker = ({ map, position }) => {
  return new google.maps.Marker({ map, position });
};
var responses = {};

// New function to track user's location.
var trackLocation = ({ onSuccess, onError = () => { } }) => {
  options = {
    enableHighAccuracy: true,
    timeout: 10000,
    //maximumAge: 1000
  };

  //if ('geolocation' in navigator === false) {
  if (!navigator.geolocation) {
    return onError(new Error('Geolocation is not supported by your browser.'));
  }
  console.log("tracklocation");
  // Use watchPosition instead.
  //TODO: COMMENTED THIS LINE return navigator.geolocation.watchPosition(onSuccess, onError, options);
};

async function setMarkers(map) {
  var temp = allInfo();
  var info = [];
  await temp.then(function (value) {allinfo = value;});
  info = allinfo;
  /*var allpaths = [];
  for (var i = 0; i < info.length; i++) {
    allpaths.push(info[i].filePath);
  }
  loadAllFiles(allpaths);*/
  for (var i = 0; i < info.length; i++) {
   if (info[i].generalDesc !== ''){
     var newmarker = new google.maps.Marker({
      position: {lat:info[i].latitude, lng:info[i].longitude},
      map: map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 2.5,
        strokeColor: '#FFA07A',
      },
      zIndex : 999,
    });
    contentString = '<div id="content"><div id="siteNotice"></div>'+
                    '<div><h3>'+ info[i].TrackName  +'</h3></div>';
                   // '<div><p>Description: </p><div id="marker'+ i.toString() +'"></div></div></div>';
    attachSecretMessage(newmarker, contentString);
   }
  }
}

function attachSecretMessage(marker, secretMessage) {
  var infowindow = new google.maps.InfoWindow({
    content: secretMessage
  });

  marker.addListener('click', function() {
    infowindow.open(marker.get('map'), marker);
  });
}

function validateLocation(poss) {
  var ac = poss.coords.accuracy;
  // for testing
  console.log(ac);
  //return true;
  //alert(ac);
  //console.log(ac);
  if (!is_init_pos) {
     //alert(ac);
     if (ac < 50) {
        is_init_pos = true;
        return true;
     }
     else return false;
  }
  else {
    if (ac < 10) return true;
    else return false;
  }
}

var invalid = 0;
var update = false;
function autoUpdate() {
  options = {
      enableHighAccuracy: true,
      timeout: Infinity,
      maximumAge: 0
  };
  function error(err) {
    console.warn('ERROR(' + err.code + '): ' + err.message);
  	alert("Please enable location service.")
  }

  function success(poss) {
    //console.log(poss.coords.accuracy);
    var lat = poss.coords.latitude;
    var lng = poss.coords.longitude;
    var ac = poss.coords.accuracy;
   // alert(ac);
 //   console.log(heading);
    var pos = {lat, lng};
    cur_pos = pos;
    // Find out which valley user is at.
    //console.log("here")
    user_position = findValley(pos);
    switchvalley = switchValley(prevposs, poss);
   // console.log(user_position);
    var valid = validateLocation(poss);
    console.log(user_position);
    if(valid || invalid > 5){
      invalid = 0;
      update = true;
      if (user_position != -1) {
       // console.log(user_position);
        if (!soloon) {
          setPanner(pos, user_position);
        }

        if (prev != user_position && switchvalley){
          stopAudio();
          introPage(pos, user_position, true);
        }
        else if (prev == -1){
          //console.log(audio.state);
         //if (switchvalley)
            introPage(pos, user_position, false);
        }
      }
      else {
        if (switchvalley){
          console.log("stop audio"); stopAudio();
        }
      }
    }
    else {
      update = false;
      invalid += 1;
    }
    if (update){
      prevpos = pos;
      prevposs = poss;
      prev = user_position;
      marker.setPosition({ lat, lng });
      maps.panTo(new google.maps.LatLng(lat, lng));
      //maps.setZoom(16);
      if ( user_position == -1) {
	 pop = document.querySelector('.popinfo');
         pop.innerHTML = "";
      }
    }
    //maps.setCenter(new google.maps.LatLng(lat, lng));
  }
  d = navigator.geolocation.watchPosition(success, error, options);
}

function switchValley(prevposs, poss) {
  console.log(switch_history);
  if ( prevposs == -1) prevposs = poss;
  var lat = poss.coords.latitude;
  var lng = poss.coords.longitude;
  var cur_ac = poss.coords.accuracy;
  var cur_pos = {lat, lng};
  lat = prevposs.coords.latitude;
  lng = prevposs.coords.longitude;
  var prev_ac = poss.coords.accuracy;
  var prev_pos = {lat, lng};
  var prev_valley = findValley(prev_pos);
  var cur_valley = findValley(cur_pos);
  switch_history_length = document.getElementById("switch_history_length").value;
  if (switch_history.length < switch_history_length) {switch_history.push(cur_valley);}
  else {
    switch_history.shift();
    switch_history.push(cur_valley);
  }
  diff = 0;
  for (i=0; i<switch_history.length-1; i++) {
    if(switch_history[i] != switch_history[i+1]) diff += 1;
  }
  if (diff > 2) return false;
  else return true;
  /*
  if (cur_valley != prev_valley) {
    if (cur_ac > 10 || prev_ac > 10 || diff > 2){
      return false;
    }
    else {
      return true;
    }
  }
  else {
    if (diff > 2) return false;
    else return true;
  }*/
}

// Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see the error "The Geolocation service
// failed.", it means you probably did not give permission for the browser to
// locate you.

function initMap() {
//  var map, infoWindow;
  //var pos, prevpos = -1;
  var initialPosition = {lat: 53.40682,lng: -113.758825};
  const map = createMap(initialPosition);
  maps = map;
  var icon = {
    url: "/images/direction.png", // url
    scaledSize: new google.maps.Size(20, 20), // scaled size
//    origin: new google.maps.Point(0,0), // origin
    anchor: new google.maps.Point(0, 0) // anchor
  };
  map.addListener("center_changed", () => {
    // 3 seconds after the center of the map has changed, pan back to the
    // marker.
    window.setTimeout(() => {
      map.panTo(marker.getPosition());
      map.setZoom(16);
    }, 5000);
  });
  marker = new google.maps.Marker({
        clickable : false,
        icon: {
          path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
          scale: 2.5,
          strokeColor: '#0000EE',
        },
        shadow : null,
        zIndex : 999,
        map : map
  });
  user_marker = marker;
  //$$('.download').show();
    //var prev = -1;
  setMarkers(map);
  //if ('ondeviceorientationabsolute' in window) {
    // Chrome 50+ specific
  window.addEventListener('deviceorientationabsolute', handleOrientation, true);
  autoUpdate();
  birdSongs(1);
  // Use the new trackLocation function.
  // draw polygons.
  var v = drawPolygons()
  for (var i = 0; i < numValleys; i++) {
    v[i].setMap(map);
  }
  for (var i = 0; i < numValleys*2; i++) {
    var imge = {
      url: '/images/s-number-'+(i%7+1)+'.png',
      // This marker is 20 pixels wide by 32 pixels high.
      //size: new google.maps.Size(20, 32),
      // The origin for this image is (0, 0).
      //origin: new google.maps.Point(0, 0),
      // The anchor for this image is the base of the flagpole at (0, 32).
      //anchor: new google.maps.Point(0, 32)
    };
    var mark = new google.maps.Marker({
      icon: imge,
      position: num_marker_pos[i],
    });
    // To add the marker to the map, call setMap();
    mark.setMap(map);

  }

}
function handleOrientation (event) {
  var alpha = null;
  //Check for iOS property
  if (event.absolute) {
   alpha = 360 - event.alpha;
  }
  else if (event.hasOwnProperty('webkitCompassHeading')) {
   alpha = 360 - event.webkitCompassHeading;
  }
  else {
    alpha = 360 - event.alpha;
  }
  var locationIcon = marker.get('icon');
  locationIcon.rotation = alpha;
  marker.set('icon', locationIcon);
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
  infoWindow.open(map);
}
